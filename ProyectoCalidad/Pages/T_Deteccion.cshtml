@page
@model ProyectoCalidad.Pages.T_DeteccionModel
@{
    ViewData["Title"] = "GraficasDeteccion";
    int cont = 0;
    string _tags = "";
    int[] _values = new int[200];
    int count = 0;
    int contRun = 0, contLin = 0, contLib = 0, contLeak = 0;
    string bs64 = "";
}
<head>
    <!-- style css -->
    <link href="@Url.Content("~/css/style.css")" rel="stylesheet" />
    <!-- Responsive-->
    <link href="@Url.Content("~/css/responsive.css")" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.8.2/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.3/jspdf.min.js"></script>
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/css/styleTables.css")"/>

</head>
    

<body class="main-layout">
    <div class="text-center">
        <h1 class="display-4">Detecciones</h1>
    </div>
    <form>
        <p>
            Fecha Inicio: <input type="date" id="FechaI" asp-for="SearchString"/> <a>  </a>
            Fecha Final: <input type="date" id="FechaF" asp-for="SearchString2"/>
            <input type="submit" value="Buscar" class="btn btn-info" />
        </p>
    </form>

    <center>
        <canvas id="myChart" style="width:100%;max-width:700px"></canvas>
    </center>

    <center> 
        <h2>Tabla Detecciones</h2>
    </center>
    <table class="table table-hover" id="tblData" style="font-size:14px;">
        <thead>
            <tr>
                <th>
                    Fecha
                </th>
                <th>
                    Detección
                </th>
                <th>
                    Cantidad
                </th>
            </tr>
        </thead>
        <tbody>    
            @{
                foreach (var item2 in Model.Formulario_Model)
                {                    
                    <tr>
                        <td>
                            @Html.DisplayFor(modelItem => item2.ReleaseDate)
                        </td>
                        <td>                
                            @item2.Deteccion
                        </td>
                        <td>
                            @item2.DetCount
                        </td>
                    </tr>
                    if (@item2.Deteccion == "Run Test")
                    {
                        contRun = contRun + @item2.DetCount;
                    }
                    else if (@item2.Deteccion == "Linea")
                    {
                        contLin = contLin + @item2.DetCount;
                    }
                    else if (@item2.Deteccion == "Liberacion")
                    {
                        contLib = contLib + @item2.DetCount;
                    }
                    else if (@item2.Deteccion == "Leak Test")
                    {
                        contLeak = contLeak + @item2.DetCount;
                    }
                    cont = cont + @item2.DetCount;
                }
            }
            <tr>
                <td>

                </td>
                <td>
                    <strong>Totales: </strong>
                </td>
                <td>
                    <strong>@cont</strong>
                </td>
            </tr>        
        </tbody>     
      </table>
      <br />
        <div style="text-align:left">
            <h3><a asp-page="./Graficas">DPU</a>
                    <a> | </a>
                    <a asp-page="./T_Paretos">Paretos</a></h3>
        </div>

        <div style="text-align:right; font-size:14px;">
            <a asp-page="./T_Deteccion"><b>↩Back to List</b></a>
        </div>
        
        <div>
            <textarea id="Base66" style="visibility: hidden;" ></textarea>
        </div>
        
        </body>

@{   
    @foreach (var item2 in Model.Formulario_Model)
    {
        _tags = ",RunTest " + @contRun + ",Linea " + @contLin + ",Liberacion " + @contLib + ",LeakTest " + @contLeak;
        _values[0] = contRun;
        _values[1] = contLin;
        _values[2] = contLib;
        _values[3] = contLeak;
        count++;
    }
    var yourJavaScriptArray = Html.Raw(Json.Serialize(_values));
    <input type="hidden" id="tags" value="@_tags"/>
    <input type="hidden" id="values" value="@yourJavaScriptArray"/>

}
@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }            
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs5/jszip-2.5.0/dt-1.13.1/b-2.3.3/b-html5-2.3.3/r-2.4.0/datatables.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript">
        $(document).ready(function() {

            if ($('#myChart').length) {
                var xValues = document.getElementById('tags').value.replace(/\[|\]/g, '').split(',')
                var yValues = Array.from(document.getElementById('values').value.replace(/\[|\]/g, '').split(',')).map(Number)
                xValues.shift()
                var barColors = [
                    "#b91d47",
                    "#00aba9",
                    "#2b5797",
                    "#e8c3b9"
                    ];
                var chart = new Chart("myChart", {
                    type: "pie",
                    data: {
                        labels: xValues,
                        datasets: [{
                            backgroundColor: barColors,
                            data: yValues
                        }]
                    },
                    options: {
                        title: {
                            display: true,
                            text: "Gráfica Detecciones" 
                        }
                    }
                });  
            }  
            
            $('#myChart').on('click',function(){
                $('#Base66').val( chart.toBase64Image() );     
                url64 = $('#Base66').val();

                $('#tblData').DataTable( {
                    dom: "<'row'<'col-sm-12 col-md-5'l><'col-sm-12 col-md-7'f>>" +
                         "<'row'<'col-sm-12'tr>>" +                                    
                         "<'col-sm-12 col-md-7'B>",
                    buttons: [{
                        extend: 'pdfHtml5',
                        text: 'PDF',
                        className: 'btn btn-danger',                                                                                                                                   
                        customize: function ( doc ) {
                            doc.content.splice( 1, 0, {
                                width: 550,
                                height: 250,
                                alignment: 'center',
                                image: url64
                            });
                        }
                    }],
                    responsive: true,                                                     
                    retrieve: true
                });                                            
            });           
        });
    </script>
}

