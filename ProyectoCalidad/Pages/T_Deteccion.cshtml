@page
@model ProyectoCalidad.Pages.T_DeteccionModel
@{
    ViewData["Title"] = "GraficasDeteccion";
    int cont = 0;
    string _tags = "";
    int[] _values = new int[200];
    int count = 0;
    int contRun = 0, contLin = 0, contLib = 0, contLeak = 0;
}
<head>
    <!-- style css -->
    <link href="@Url.Content("~/css/style.css")" rel="stylesheet" />
    <!-- Responsive-->
    <link href="@Url.Content("~/css/responsive.css")" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.8.2/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.3/jspdf.min.js"></script>
</head>
    

<body class="main-layout">
    <div class="text-center">
        <h1 class="display-4">Detecciones</h1>
    </div>
    <form>
        <p>
            Fecha Inicio: <input type="date" id="FechaI" asp-for="SearchString"/> <a>  </a>
            Fecha Final: <input type="date" id="FechaF" asp-for="SearchString2"/>
            <input type="submit" value="Buscar" class="btn btn-info" />
        </p>
    </form>

    <center>
        <canvas id="myChart" style="width:100%;max-width:700px"></canvas>
    </center>

    <div id="pdf">
    <table class="table table-hover" id="table" style="font-size:14px;">
        <thead>
            <tr>
                <th>
                    Fecha
                </th>
                <th>
                    Detección
                </th>
                <th>
                    Cantidad
                </th>
            </tr>
        </thead>
        <tbody>    

            @{
                foreach (var item2 in Model.Formulario_Model)
                {
                    
                                                <tr>
                                                    <td>
                                                        @Html.DisplayFor(modelItem => item2.ReleaseDate)
                                                    </td>
                                                    <td>                
                                                        @item2.Deteccion
                                                    </td>
                                                    <td>
                                                        @item2.DetCount
                                                    </td>
                                                </tr>
                        if (@item2.Deteccion == "Run Test")
                        {
                            contRun = contRun + @item2.DetCount;
                        }
                        else if (@item2.Deteccion == "Linea")
                        {
                            contLin = contLin + @item2.DetCount;
                        }
                        else if (@item2.Deteccion == "Liberacion")
                        {
                            contLib = contLib + @item2.DetCount;
                        }
                        else if (@item2.Deteccion == "Leak Test")
                        {
                            contLeak = contLeak + @item2.DetCount;
                        }
                        cont = cont + @item2.DetCount;
                    }

                }

             
            <tr>
                <td>

                </td>
                <td>
                    <strong>Totales: </strong>
                </td>
                <td>
                    <strong>@cont</strong>
                </td>
            </tr>
             <tr>
                <td>
                    <h3><a asp-page="./Graficas">DPU</a>
                    <a> | </a>
                    <a asp-page="./T_Paretos">Paretos</a></h3> 
                </td>
                <td>

                </td>
                <td>
                    <a asp-page="./T_Deteccion"><b>↩Back to List</b></a>
                </td>
            </tr>
            <br /><br />
            <center> 
                <h2>  
                    Tabla Detecciones
                </h2>
            </center>
        </tbody>     
      </table>
      </div>
      <div class="form-group">
        <input type="submit" id="download" value="Download" class="btn btn-danger"/>
        @*<input type="submit" value="Create" class="btn btn-primary" />*@
      </div>
    </body>

@{   
    @foreach (var item2 in Model.Formulario_Model)
    {
        _tags = ",RunTest "+@contRun+",Linea "+@contLin+",Liberacion "+@contLib+",LeakTest "+@contLeak;
        _values[0] = contRun;
        _values[1] = contLin;
        _values[2] = contLib;
        _values[3] = contLeak;
        count++;
    }
    var yourJavaScriptArray = Html.Raw(Json.Serialize(_values));
    <input type="hidden" id="tags" value="@_tags"/>
    <input type="hidden" id="values" value="@yourJavaScriptArray"/>

}
<script>
        if ($('#myChart').length) {
            var xValues = document.getElementById('tags').value.replace(/\[|\]/g, '').split(',')
            var yValues = Array.from(document.getElementById('values').value.replace(/\[|\]/g, '').split(',')).map(Number)
            xValues.shift()
            var barColors = [
              "#b91d47",
              "#00aba9",
              "#2b5797",
              "#e8c3b9"
            ];
            new Chart("myChart", {
              type: "pie",
              data: {
                labels: xValues,
                datasets: [{
                  backgroundColor: barColors,
                  data: yValues
                }]
              },
              options: {
                title: {
                  display: true,
                  text: "Gráfica Detecciones" 
                }
              }
            });

            document.getElementById("download").addEventListener("click", function () {
                var imgData = document.getElementById('myChart').toDataURL("Descargas/jpeg", 1.0);
                var maintable = document.getElementById('table');
                var pdf = new jsPDF();
                pdf.addImage(imgData, 'JPEG', 0, 0);
                pdf.addHtml(maintable);

                pdf.save("GraficaDeteccion.pdf");
            }, true);    
        }                  
</script>
